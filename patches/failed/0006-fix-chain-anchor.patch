From 1111111111111111111111111111111111111111 Mon Sep 17 00:00:00 2001
From: AppFightSmart Patch Assistant <patch@appfightsmart.local>
Date: Mon, 11 Aug 2025 03:00:15 +0000
Subject: [PATCH] SensorOverlay: fix chain stretch/rotation to anchor correctly

---
 app/src/main/java/com/example/appfightsmart/SensorOverlay.kt | 19 ++++++++++++++-----
 1 file changed, 14 insertions(+), 5 deletions(-)

diff --git a/app/src/main/java/com/example/appfightsmart/SensorOverlay.kt b/app/src/main/java/com/example/appfightsmart/SensorOverlay.kt
@@ -152,11 +152,17 @@ fun SensorOverlay(
     ) { 
         val anchorY = 6f
         val bagTopX = tx
         val bagTopY = topMarginPx + tyArc + tyDepth
 
-        // CHAIN (stretched & rotated)
-        val ropeLenPx = (bagTopY + attachOffsetIntoSpritePx) - anchorY
-        if (ropeLenPx > 2f) {
-            val angleDeg = Math.toDegrees(
-                atan2(
-                    bagTopX.toDouble(),
-                    (bagTopY + attachOffsetIntoSpritePx - anchorY).toDouble()
-                )
-            ).toFloat()
+        // CHAIN (true distance + correct rotation from fixed ceiling anchor to bag attach point)
+        val dx = bagTopX
+        val dy = (bagTopY + attachOffsetIntoSpritePx) - anchorY
+        val ropeLenPx = sqrt(dx * dx + dy * dy)
+        if (ropeLenPx > 2f) {
+            // angle between rope vector (dx, dy) and the downward vertical axis
+            val angleDeg = Math.toDegrees(atan2(dx.toDouble(), dy.toDouble())).toFloat()
 
             Image(
                 painter = painterResource(id = R.drawable.metal_chain),
                 contentDescription = "Chain",
                 contentScale = ContentScale.FillBounds,
                 modifier = Modifier
                     .width(14.dp)
                     .height(ropeLenPx.dp)
-                    .offset(x = bagTopX.dp - 7.dp, y = anchorY.dp)
+                    // Top of chain stays fixed at the ceiling anchor (x = 0), not at bagTopX.
+                    // We rotate around the top, so position the chain's top-center at (0, anchorY).
+                    .offset(x = (-7).dp, y = anchorY.dp)
                     .graphicsLayer { 
                         rotationZ = angleDeg
                         transformOrigin = androidx.compose.ui.graphics.TransformOrigin(0.5f, 0f)
                         alpha = 0.98f
                     }
             )
         }
-- 
2.45.0
